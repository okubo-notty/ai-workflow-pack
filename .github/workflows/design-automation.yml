name: Design Automation with 3-Loop (Gemini Flash Free Safe)

on:
  workflow_dispatch:
    inputs:
      iteration:
        description: 'ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ—å›æ•° (æ‰‹å‹•å®Ÿè¡Œæ™‚ã¯1ã®ã¾ã¾ã§OK)'
        default: '1'
        required: true

# âœ… åŒæ™‚å®Ÿè¡Œã‚’ç¦æ­¢ï¼ˆã“ã‚ŒãŒè¶…é‡è¦ï¼‰
concurrency:
  group: design-automation
  cancel-in-progress: false

jobs:
  design-and-review:
    runs-on: self-hosted
    outputs:
      verdict: ${{ steps.review.outputs.verdict }}

    steps:
      - uses: actions/checkout@v4

      - name: Gitè¨­å®š
        run: |
          git config user.name "github-actions[ai-bot]"
          git config user.email "ai-bot@users.noreply.github.com"

      ###########################################################
      # 3. Gemini Flash (ç„¡æ–™ç‰ˆ) + 429å®Œå…¨å›é¿ãƒ©ãƒƒãƒ‘ãƒ¼
      ###########################################################
      - name: è©³ç´°è¨­è¨ˆç”Ÿæˆ (Gemini Flash Free Safe)
        run: |
          mkdir -p design requirements .ai

          if [ "${{ github.event.inputs.iteration }}" == "1" ]; then
            PROMPT="requirements/BRD.md ã®è¦ä»¶ã‚’æº€ãŸã™è©³ç´°è¨­è¨ˆæ›¸(DETAIL.md)ã¨Gherkinãƒ†ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚Markdownå½¢å¼ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚"
          else
            FIX_INST=$(cat .ai/fix_instructions.txt)
            PROMPT="å‰å›ã®è¨­è¨ˆã«å¯¾ã™ã‚‹ä»¥ä¸‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜ã‚’ä¿®æ­£ã—ã€å®Œç’§ãªè©³ç´°è¨­è¨ˆæ›¸ã‚’å†å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚æŒ‡æ‘˜: $FIX_INST"
          fi

          #########################################
          # âœ… 429çµ¶å¯¾å›é¿ï¼šæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ç„¡é™ãƒªãƒˆãƒ©ã‚¤
          #########################################
          ATTEMPT=0
          MAX_WAIT=120

          while true
          do
            ATTEMPT=$((ATTEMPT+1))
            echo "Geminiå‘¼ã³å‡ºã—è©¦è¡Œ: $ATTEMPT"

            # å°‘ã—å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œï¼ˆç„¡æ–™æ ä¿è­·ï¼‰
            SLEEP_TIME=$(( (RANDOM % 5) + 5 ))
            echo "äº‹å‰ã‚¹ãƒªãƒ¼ãƒ— ${SLEEP_TIME}s"
            sleep $SLEEP_TIME

            # gemini-1.5-flash ã‚’æ˜ç¤ºæŒ‡å®š
            if bin/llm_run gemini-flash "$PROMPT" > design/DETAIL.md 2>error.log; then
              echo "GeminiæˆåŠŸ"
              break
            fi

            # 429æ¤œå‡º
            if grep -q "429" error.log; then
              WAIT=$(( 2 ** ATTEMPT ))
              if [ $WAIT -gt $MAX_WAIT ]; then
                WAIT=$MAX_WAIT
              fi
              echo "429æ¤œå‡ºã€‚${WAIT}ç§’å¾…æ©Ÿã—ã¦å†è©¦è¡Œ..."
              sleep $WAIT
            else
              echo "APIã‚¨ãƒ©ãƒ¼ã€‚10ç§’å¾Œã«å†è©¦è¡Œ..."
              sleep 10
            fi
          done

      ###########################################################
      # 4. AIãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã“ã¡ã‚‰ã‚‚å®‰å…¨åŒ–ï¼‰
      ###########################################################
      - name: AIãƒ¬ãƒ“ãƒ¥ãƒ¼
        id: review
        run: |
          PROMPT="design/DETAIL.md ã‚’èª­ã¿è¾¼ã¿ã€è¦ä»¶å®šç¾©ã¨ã—ã¦å®Ÿè£…å¯èƒ½ã‹å³æ ¼ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã›ã‚ˆã€‚å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚ {\"verdict\": \"pass\" ã¾ãŸã¯ \"fail\", \"rewrite_instructions\": \"Failã®å ´åˆã®å…·ä½“çš„ãªä¿®æ­£æŒ‡ç¤º\"}"

          ATTEMPT=0
          while true
          do
            ATTEMPT=$((ATTEMPT+1))
            sleep 5

            if RESULT=$(bin/llm_run opencode "$PROMPT" 2>error.log); then
              break
            fi

            if grep -q "429" error.log; then
              WAIT=$(( 2 ** ATTEMPT ))
              echo "Review 429ã€‚${WAIT}så¾…æ©Ÿ..."
              sleep $WAIT
            else
              sleep 10
            fi
          done

          VERDICT=$(echo $RESULT | jq -r .verdict)
          echo "verdict=$VERDICT" >> $GITHUB_OUTPUT

          if [ "$VERDICT" == "fail" ]; then
            echo $RESULT | jq -r .rewrite_instructions > .ai/fix_instructions.txt
          fi

      ###########################################################
      # Gitä¿å­˜
      ###########################################################
      - name: Gitã‚³ãƒŸãƒƒãƒˆ
        run: |
          git add design/DETAIL.md .ai/fix_instructions.txt || true
          git commit -m "AI Update: Design iteration ${{ github.event.inputs.iteration }}" || true
          git push origin HEAD

      ###########################################################
      # ãƒ«ãƒ¼ãƒ—åˆ¶å¾¡
      ###########################################################
      - name: Failæ™‚ãƒªãƒˆãƒ©ã‚¤
        if: steps.review.outputs.verdict == 'fail' && github.event.inputs.iteration < 3
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEXT_ITER=$((${{ github.event.inputs.iteration }} + 1))
          sleep 20  # ç„¡æ–™æ ä¿è­·
          gh workflow run design-automation.yml -f iteration=$NEXT_ITER

      - name: 3å›Fail
        if: steps.review.outputs.verdict == 'fail' && github.event.inputs.iteration == '3'
        run: |
          echo "::error::3å›å¤±æ•—ã€‚äººé–“ä»‹å…¥ãŒå¿…è¦ã€‚"
          exit 1

  human-approval:
    needs: design-and-review
    if: needs.design-and-review.outputs.verdict == 'pass'
    runs-on: ubuntu-latest
    environment: production-approval
    steps:
      - run: echo "ğŸ‰ AIãƒ¬ãƒ“ãƒ¥ãƒ¼é€šéã€‚æœ€çµ‚æ‰¿èªã—ã¦ãã ã•ã„ã€‚"