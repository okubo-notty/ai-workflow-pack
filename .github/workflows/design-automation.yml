name: Design Automation (Self-Hosted / Gemini Self-Review + OpenCode Review)

on:
  workflow_dispatch:
    inputs:
      iteration:
        description: '現在のループ回数'
        default: '1'
        required: true

concurrency:
  group: design-automation
  cancel-in-progress: false

jobs:
  design-and-review:
    runs-on: self-hosted
    outputs:
      verdict: ${{ steps.review.outputs.verdict }}

    steps:
      - uses: actions/checkout@v4

      ###########################################################
      # 1️⃣ Gemini ツール制限
      ###########################################################
      - name: Setup Gemini Tool Restriction
        run: |
          mkdir -p .gemini
          cat > .gemini/settings.json << 'EOF'
          {
            "tools": {
              "core": ["ReadFileTool", "GlobTool", "SearchText"]
            },
            "useWriteTodos": false,
            "telemetry": { "enabled": false }
          }
          EOF

      ###########################################################
      # 2️⃣ BRD.md 自動生成 (prompts/design_gen.txt 参照)
      ###########################################################
      - name: Generate BRD.md if missing
        run: |
          mkdir -p requirements
          PROMPT_FILE="github/prompts/design_gen.txt"
          if [ ! -f "$PROMPT_FILE" ]; then
            echo "::error::${PROMPT_FILE} が存在しないため生成中..."
            exit 1
          fi

          if [ ! -f requirements/BRD.md ]; then
            echo "requirements/BRD.md が存在しないため生成中..."
            PROMPT=$(<"$PROMPT_FILE")
            RESULT=$(bin/llm_run gemini "$PROMPT")
            echo "$RESULT" | jq -r `.response` > requirements/BRD.md
            echo "requirements/BRD.mdを生成しました"
          else
            echo "requirements/BRD.md がすでに存在します。"
          fi

      ###########################################################
      # 3️⃣ 詳細設計生成 + Geminiセルフレビュー
      ###########################################################
      - name: Generate Design (with Gemini Self-Review)
        run: |
          mkdir -p design .ai

          if [ "${{ github.event.inputs.iteration }}" == "1" ]; then
            BASE_PROMPT="requirements/BRD.md の要件を基に詳細設計書とGherkinテストを作成してください。"
          else
            FIX_INST=$(cat .ai/fix_instructions.txt)
            BASE_PROMPT="前回のレビュー指摘を反映して設計書を再生成してください。
            修正指示: $FIX_INST"
          fi

          FILE_CONTENT=$(<requirements/BRD.md)
          PROMPT="$FILE_CONTENT"$'\n'"$BASE_PROMPT"$'\n'"--- 手順 ---"$'\n'"1. 詳細設計書を作成する。"$'\n'"2. その設計を自己レビューする。"$'\n'"3. 問題があれば修正する。"$'\n'"4. 最終版のみMarkdownで出力する。"$'\n'"出力は最終設計書のみ。"

          RESULT=$(bin/llm_run gemini "$PROMPT")
          echo "$RESULT" | jq -r '.response' > design/DETAIL.md

      ###########################################################
      # 4️⃣ OpenCodeによるAIレビュー
      ###########################################################
      - name: AI Review by OpenCode
        id: review
        run: |
          FILE_CONTENT=$(<design/DETAIL.md)
          PROMPT="$FILE_CONTENT"$'\n'"要件定義として実装可能か厳格にレビューせよ。"$'\n'"必ず以下のJSON形式で回答せよ：
          {
            \"verdict\": \"pass\" または \"fail\",
            \"rewrite_instructions\": \"Failの場合の具体的修正指示\"
          }"

          RESULT=$(bin/llm_run opencode "$PROMPT")
          echo "$RESULT" > review.json

          VERDICT=$(echo "$RESULT" | jq -r '.verdict')
          echo "verdict=$VERDICT" >> $GITHUB_OUTPUT

          if [ "$VERDICT" == "fail" ]; then
            echo "$RESULT" | jq -r '.rewrite_instructions' > .ai/fix_instructions.txt
          fi

      ###########################################################
      # 5️⃣ Google Antigravity による承認フロー
      ###########################################################
      - name: Antigravity Diff Check
        if: steps.review.outputs.verdict == 'pass'
        run: |
          antigravity diff design/ requirements/

      - name: Human Approval (GitHub Environment)
        if: steps.review.outputs.verdict == 'pass'
        uses: hmarr/auto-approve-action@v2
        with:
          environment: production-approval

      - name: Save Final AI Design
        if: steps.review.outputs.verdict == 'pass'
        run: |
          mkdir -p final
          cp design/DETAIL.md final-ai-design.yaml
          echo "最終成果物を final-ai-design.yaml として保存"

      ###########################################################
      # 6️⃣ Git保存
      ###########################################################
      - name: Commit Results
        run: |
          git config user.name "github-actions[ai-bot]"
          git config user.email "ai-bot@users.noreply.github.com"
          git add design/DETAIL.md review.json .ai/fix_instructions.txt requirements/BRD.md || true
          git commit -m "AI Update: iteration ${{ github.event.inputs.iteration }}" || true
          git push origin HEAD

      ###########################################################
      # 7️⃣ Fail時リトライ
      ###########################################################
      - name: Retry if Fail
        if: steps.review.outputs.verdict == 'fail' && github.event.inputs.iteration < 3
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEXT_ITER=$((${{ github.event.inputs.iteration }} + 1))
          gh workflow run "${{ github.workflow }}" -f iteration=$NEXT_ITER

      ###########################################################
      # 8️⃣ 3回Failで停止
      ###########################################################
      - name: Stop after 3 fails
        if: steps.review.outputs.verdict == 'fail' && github.event.inputs.iteration == '3'
        run: |
          echo "::error::3回失敗しました。人間の介入が必要です。"
          exit 1