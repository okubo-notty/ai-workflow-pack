name: AI Full Design Automation (Free Stable)

on:
  workflow_dispatch:

# 同時実行防止
concurrency:
  group: ai-design-free
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  design-and-review:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Design + Acceptance + Self Review (Single Call)
        id: generate
        run: |
          mkdir -p design requirements .ai

          ITERATION=$(jq -r '.iteration // 0' .ai/state.json 2>/dev/null || echo 0)
          ITERATION=$((ITERATION+1))
          echo "{\"iteration\": $ITERATION}" > .ai/state.json

          echo "Sleeping to avoid rate spike..."
          sleep 10

          RESULT=$(bin/llm_run gemini "
          以下を順番に実行せよ。

          1. 詳細設計書をJSON形式で生成
          2. その設計からGherkin受入基準を生成
          3. 自己レビューを行い Pass/Fail を判定

          出力は必ず以下JSON形式:
          {
            \"design\": {...},
            \"acceptance\": \"...\",
            \"verdict\": \"pass\" or \"fail\"
          }
          " --model gemini-2.5-flash --output-format json)

          echo "$RESULT" > full_result.json

          VERDICT=$(echo "$RESULT" | jq -r '.verdict')

          echo "$RESULT" | jq '.design' > design/DETAIL.json
          echo "$RESULT" | jq -r '.acceptance' > requirements/Acceptance.feature

          echo "VERDICT=$VERDICT"

          if [ "$VERDICT" != "pass" ]; then
            echo "Self-review failed"
            exit 1
          fi

      - name: Commit AI state.json
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .ai/state.json
          git commit -m "Update AI iteration" || echo "No changes"
          git push

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: final-ai-design
          path: |
            design/DETAIL.json
            requirements/Acceptance.feature