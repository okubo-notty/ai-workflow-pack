name: AI Full Design Automation (Safe Gemini CLI)

on:
  workflow_dispatch:

concurrency:
  group: ai-design-free
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  design-and-review:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------
      # Geminiツール制限
      # -----------------------------
      - name: Setup Gemini settings
        run: |
          mkdir -p .gemini
          cat > .gemini/settings.json << 'EOF'
          {
            "tools": {
              "core": ["ReadFileTool", "GlobTool", "SearchText"]
            },
            "useWriteTodos": false,
            "telemetry": { "enabled": false }
          }
          EOF

      # -----------------------------
      # AI設計・受入基準生成
      # -----------------------------
      - name: Generate Design + Acceptance
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -e
          mkdir -p design requirements .ai

          # iteration管理
          ITERATION=$(jq -r '.iteration // 0' .ai/state.json 2>/dev/null || echo 0)
          ITERATION=$((ITERATION+1))
          echo "{\"iteration\": $ITERATION}" > .ai/state.json

          echo "Sleeping 3s..."
          sleep 3

          # ---------- 詳細設計 ----------
          DESIGN_PROMPT="詳細設計書をJSON形式のテキストとして回答してください。
          ファイル書き込み・コマンド実行・TODO作成は不要です。
          stdoutにJSONのみを出力してください。"

          RAW=$(gemini -p "$DESIGN_PROMPT" \
            --output-format json \
            --approval-mode auto_edit)

          # stdoutからJSON部分だけ抽出
          JSON=$(echo "$RAW" | sed -n '/^{/,/^}$/p')

          # JSON妥当性チェック
          if ! echo "$JSON" | jq -e . >/dev/null; then
            echo "Gemini did not return valid JSON"
            echo "$RAW"
            exit 1
          fi

          # .response抽出して保存
          echo "$JSON" | jq -r '.response' | jq . > design/DETAIL.json

          # ---------- 受入基準 ----------
          ACCEPT_PROMPT="以下の設計からGherkin受入基準を生成してください。
          ファイル操作やツール呼び出しは不要です。
          stdoutにJSONのみを出力してください。"

          RAW_ACC=$(cat design/DETAIL.json \
            | gemini -p "$ACCEPT_PROMPT" \
              --output-format json \
              --approval-mode auto_edit)

          JSON_ACC=$(echo "$RAW_ACC" | sed -n '/^{/,/^}$/p')
          if ! echo "$JSON_ACC" | jq -e . >/dev/null; then
            echo "Gemini did not return valid JSON for Acceptance"
            echo "$RAW_ACC"
            exit 1
          fi

          echo "$JSON_ACC" | jq -r '.response' > requirements/Acceptance.feature

      # -----------------------------
      # AIレビュー
      # -----------------------------
      - name: Review Design
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -e

          REVIEW_PROMPT="design/DETAIL.json と requirements/Acceptance.feature をレビューし、
          以下のJSON構造でテキストとして回答してください。
          ファイル操作は不要です。

          {
            \"verdict\": \"pass|fail\",
            \"issues\": [],
            \"score\": 0
          }"

          RAW_REVIEW=$(cat design/DETAIL.json requirements/Acceptance.feature \
            | gemini -p "$REVIEW_PROMPT" \
              --output-format json \
              --approval-mode auto_edit)

          JSON_REVIEW=$(echo "$RAW_REVIEW" | sed -n '/^{/,/^}$/p')
          if ! echo "$JSON_REVIEW" | jq -e . >/dev/null; then
            echo "Gemini did not return valid JSON for Review"
            echo "$RAW_REVIEW"
            exit 1
          fi

          echo "$JSON_REVIEW" | jq -r '.response' > review.json

          VERDICT=$(jq -r '.verdict' review.json)
          if [ "$VERDICT" != "pass" ]; then
            echo "Review failed"
            exit 1
          fi

      # -----------------------------
      # State更新 & アップロード
      # -----------------------------
      - name: Commit AI state.json
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .ai/state.json
          git commit -m "Update AI iteration" || echo "No changes"
          git push

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: final-ai-design
          path: |
            design/DETAIL.json
            requirements/Acceptance.feature
            review.json