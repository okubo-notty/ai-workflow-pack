name: AI Full Design Automation

on:
  workflow_dispatch:

concurrency:
  group: ai-design-free
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  design-and-review:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Design + Acceptance
        run: |
          set -e
          mkdir -p design requirements .ai

          # iteration管理
          ITERATION=$(jq -r '.iteration // 0' .ai/state.json 2>/dev/null || echo 0)
          ITERATION=$((ITERATION+1))
          echo "{\"iteration\": $ITERATION}" > .ai/state.json

          echo "Sleeping 5s..."
          sleep 5

          echo "Generating design..."
          DESIGN_JSON=$(bin/llm_run gemini \
            -p "詳細設計書をJSON形式で生成せよ。" \
            -m gemini-2.5-flash \
            --approval-mode plan \
            -o json)

          echo "$DESIGN_JSON" | jq . > design/DETAIL.json

          echo "Generating acceptance criteria..."
          ACCEPTANCE=$(bin/llm_run gemini \
            "以下の設計からGherkin受入基準を生成せよ: $DESIGN_JSON" \
            -m gemini-2.5-flash \
            --approval-mode plan \
            -o json)

          echo "$ACCEPTANCE" > requirements/Acceptance.feature

      - name: OpenCode Review
        run: |
          set -e

          echo "Running OpenCode review..."
          OPEN_RESULT=$(bin/llm_run opencode \
            "design/DETAIL.json と requirements/Acceptance.feature をレビューして Pass/Fail を JSON で返せ")

          echo "$OPEN_RESULT"

          VERDICT=$(echo "$OPEN_RESULT" | jq -r '.verdict')

          if [ "$VERDICT" != "pass" ]; then
            echo "Review failed"
            exit 1
          fi

      - name: Commit AI state.json
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .ai/state.json
          git commit -m "Update AI iteration" || echo "No changes"
          git push

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: final-ai-design
          path: |
            design/DETAIL.json
            requirements/Acceptance.feature