name: Design Automation (Self-Hosted / Gemini Self-Review + OpenCode Review)

on:
  workflow_dispatch:
    inputs:
      iteration:
        description: '現在のループ回数'
        default: '1'
        required: true

concurrency:
  group: design-automation
  cancel-in-progress: false

jobs:
  design-and-review:
    runs-on: self-hosted
    outputs:
      verdict: ${{ steps.review.outputs.verdict }}

    steps:
      - uses: actions/checkout@v4

      ###########################################################
      # 1️⃣ Gemini ツール制限
      ###########################################################
      - name: Setup Gemini Tool Restriction
        run: |
          mkdir -p .gemini
          cat > .gemini/settings.json << 'EOF'
          {
            "tools": {
              "core": ["ReadFileTool", "GlobTool", "SearchText"]
            },
            "useWriteTodos": false,
            "telemetry": { "enabled": false }
          }
          EOF

      ###########################################################
      # 2️⃣ 詳細設計生成 + Geminiセルフレビュー
      ###########################################################
      - name: Generate Design (with Gemini Self-Review)
        run: |
          mkdir -p design requirements .ai

          if [ "${{ github.event.inputs.iteration }}" == "1" ]; then
            BASE_PROMPT="requirements/BRD.md の要件を基に詳細設計書とGherkinテストを作成してください。"
          else
            FIX_INST=$(cat .ai/fix_instructions.txt)
            BASE_PROMPT="前回のレビュー指摘を反映して設計書を再生成してください。
            修正指示: $FIX_INST"
          fi

          PROMPT="$BASE_PROMPT

          --- 手順 ---
          1. 詳細設計書を作成する。
          2. その設計を自己レビューする（要件網羅性・実装可能性・曖昧性）。
          3. 問題があれば修正する。
          4. 最終版のみMarkdownで出力する。

          出力は最終設計書のみ。
          ファイル操作・コマンド実行・TODO作成は禁止。
          stdoutにMarkdownテキストとして出力すること。"

          RESULT=$(cat requirements/BRD.md 2>/dev/null \
            | gemini --model gemini-1.5-flash \
              -p "$PROMPT" \
              --output-format json \
              --approval-mode auto)

          echo "$RESULT" | jq -r '.response' > design/DETAIL.md

      ###########################################################
      # 3️⃣ OpenCodeによるAIレビュー
      ###########################################################
      - name: AI Review by OpenCode
        id: review
        run: |
          PROMPT="design/DETAIL.md を読み込み、
          要件定義として実装可能か厳格にレビューせよ。

          必ず以下のJSON形式で回答せよ：
          {
            \"verdict\": \"pass\" または \"fail\",
            \"rewrite_instructions\": \"Failの場合の具体的修正指示\"
          }"

          RESULT=$(bin/llm_run opencode "$PROMPT")

          echo "$RESULT" > review.json

          VERDICT=$(echo "$RESULT" | jq -r '.verdict')
          echo "verdict=$VERDICT" >> $GITHUB_OUTPUT

          if [ "$VERDICT" == "fail" ]; then
            echo "$RESULT" | jq -r '.rewrite_instructions' > .ai/fix_instructions.txt
          fi

      ###########################################################
      # 4️⃣ Git保存
      ###########################################################
      - name: Commit Results
        run: |
          git config user.name "github-actions[ai-bot]"
          git config user.email "ai-bot@users.noreply.github.com"
          git add design/DETAIL.md review.json .ai/fix_instructions.txt || true
          git commit -m "AI Update: iteration ${{ github.event.inputs.iteration }}" || true
          git push origin HEAD

      ###########################################################
      # 5️⃣ Fail時リトライ
      ###########################################################
      - name: Retry if Fail
        if: steps.review.outputs.verdict == 'fail' && github.event.inputs.iteration < 3
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEXT_ITER=$((${{ github.event.inputs.iteration }} + 1))
          gh workflow run "${{ github.workflow }}" -f iteration=$NEXT_ITER

      ###########################################################
      # 6️⃣ 3回Failで停止
      ###########################################################
      - name: Stop after 3 fails
        if: steps.review.outputs.verdict == 'fail' && github.event.inputs.iteration == '3'
        run: |
          echo "::error::3回失敗しました。人間の介入が必要です。"
          exit 1