#!/usr/bin/env bash
set -euo pipefail

MODE="$1"
PROMPT="$2"

MODEL="gemini-2.5-pro"
MAX_RETRY=5
MAX_WAIT=120
ATTEMPT=0

call_gemini() {
  gcloud ai models generate-content \
    --model="$MODEL" \
    --content="$PROMPT" \
    --format="json"
}

case "$MODE" in
  gemini)

    while true; do
      ATTEMPT=$((ATTEMPT+1))

      # バースト防止ランダム待機
      sleep $(( (RANDOM % 4) + 3 ))

      echo "Gemini呼び出し 試行回数: $ATTEMPT"

      if OUTPUT=$(call_gemini 2>error.log); then
        # JSON整形確認
        if echo "$OUTPUT" | jq . >/dev/null 2>&1; then
          echo "$OUTPUT"
          exit 0
        else
          echo "JSON破損検出。再試行..."
        fi
      fi

      # 429 検出
      if grep -q "429" error.log; then
        WAIT=$(( 2 ** ATTEMPT ))
        if [ $WAIT -gt $MAX_WAIT ]; then
          WAIT=$MAX_WAIT
        fi
        echo "429検出。${WAIT}s待機..."
        sleep $WAIT
      else
        echo "APIエラー発生。10秒待機..."
        sleep 10
      fi

      if [ "$ATTEMPT" -ge "$MAX_RETRY" ]; then
        echo "最大リトライ到達。失敗。"
        exit 1
      fi
    done
    ;;

  opencode)
    opencode review \
      --prompt "$PROMPT" \
      --non-interactive \
      --output json
    ;;

  *)
    echo "未知のモード: $MODE" >&2
    exit 1
    ;;
esac