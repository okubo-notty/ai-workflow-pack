#!/usr/bin/env bash

MODEL="gemini-1.5-flash"

PROMPT="$2"

ATTEMPT=0
MAX_WAIT=120

while true
do
  ATTEMPT=$((ATTEMPT+1))

  # バースト防止
  sleep $(( (RANDOM % 5) + 5 ))

  OUTPUT=$(gcloud ai models generate-content \
    --model=$MODEL \
    --content="$PROMPT" 2>error.log)

  if [ $? -eq 0 ]; then
    echo "$OUTPUT" | jq -r '.candidates[0].content.parts[0].text'
    exit 0
  fi

  if grep -q "429" error.log; then
    WAIT=$(( 2 ** ATTEMPT ))
    if [ $WAIT -gt $MAX_WAIT ]; then
      WAIT=$MAX_WAIT
    fi
    echo "429検出。${WAIT}s待機..."
    sleep $WAIT
  else
    sleep 10
  fi
done